<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç°½åˆ°å ±è¡¨åŒ¯å‡ºç³»çµ±</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft JhengHei', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(90deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        .tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
        }

        .tab {
            flex: 1;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            background: #f8f9fa;
            border: none;
            font-size: 16px;
        }

        .tab.active {
            background: white;
            color: #667eea;
            border-bottom: 3px solid #667eea;
        }

        .tab:hover {
            background: #e9ecef;
        }

        .tab-content {
            display: none;
            padding: 30px;
        }

        .tab-content.active {
            display: block;
        }

        .status-panel {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .status-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 10px;
            background: white;
            padding: 15px 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #28a745;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            margin: 5px;
        }

        .btn-primary {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
        }

        .btn-success {
            background: linear-gradient(45deg, #56ab2f, #a8e6cf);
            color: white;
        }

        .btn-danger {
            background: linear-gradient(45deg, #ff6b6b, #ffd93d);
            color: white;
        }

        .btn-info {
            background: linear-gradient(45deg, #4facfe, #00f2fe);
            color: white;
        }

        .btn-warning {
            background: linear-gradient(45deg, #f093fb, #f5576c);
            color: white;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        .form-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }

        .form-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .table-container {
            overflow-x: auto;
            border-radius: 10px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            margin-top: 20px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
        }

        th {
            background: linear-gradient(90deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        td {
            padding: 12px 15px;
            border-bottom: 1px solid #e9ecef;
            transition: background-color 0.3s ease;
        }

        tr:hover {
            background-color: #f8f9fa;
        }

        tr:nth-child(even) {
            background-color: #fafafa;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            animation: fadeIn 0.3s ease;
        }

        .modal.show {
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 40px rgba(0,0,0,0.2);
            animation: slideIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideIn {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e9ecef;
        }

        .close {
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            color: #999;
            transition: color 0.3s ease;
        }

        .close:hover {
            color: #333;
        }

        .file-upload {
            position: relative;
            overflow: hidden;
            display: inline-block;
        }

        .file-upload input[type=file] {
            position: absolute;
            left: -9999px;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 8px;
            color: white;
            font-weight: 600;
            transform: translateX(400px);
            transition: transform 0.3s ease;
            z-index: 1000;
            max-width: 400px;
            word-wrap: break-word;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.success {
            background: #28a745;
        }

        .notification.error {
            background: #dc3545;
        }

        .notification.info {
            background: #17a2b8;
        }

        .notification.warning {
            background: #ffc107;
            color: #212529;
        }

        .scanner-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .scanner-input {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .info-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #6c757d;
        }

        .empty-icon {
            font-size: 4em;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        .edit-buttons {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
        }

        .edit-buttons .btn {
            padding: 6px 12px;
            font-size: 12px;
            margin: 0;
        }

        .download-status {
            background: #e3f2fd;
            border: 1px solid #2196f3;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            color: #1976d2;
            font-weight: 500;
        }

        /* æš«å­˜æª”åŠŸèƒ½æ¨£å¼ */
        .temp-save-section {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .temp-save-section h3 {
            color: #856404;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .temp-save-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 15px;
        }

        .temp-file-info {
            background: white;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #e9ecef;
            margin-top: 15px;
        }

        .progress-indicator {
            background: #e9ecef;
            border-radius: 10px;
            height: 8px;
            margin: 10px 0;
            overflow: hidden;
        }

        .progress-bar {
            background: linear-gradient(45deg, #28a745, #20c997);
            height: 100%;
            border-radius: 10px;
            transition: width 0.3s ease;
        }

        @media (max-width: 768px) {
            .container {
                margin: 10px;
                border-radius: 15px;
            }
            
            .header h1 {
                font-size: 2em;
            }
            
            .tabs {
                flex-direction: column;
            }
            
            .modal-content {
                width: 95%;
                padding: 20px;
            }
            
            .edit-buttons {
                flex-direction: column;
            }
            
            .edit-buttons .btn {
                width: 100%;
                justify-content: center;
            }

            .temp-save-buttons {
                flex-direction: column;
            }

            .temp-save-buttons .btn {
                width: 100%;
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ¯ ç°½åˆ°å ±è¡¨åŒ¯å‡ºç³»çµ±</h1>
            <p>èª²ç¨‹è¨­å®š â†’ å§“ååŒ¯å…¥ â†’ èº«ä»½è­‰æƒæ â†’ å®Œæ•´å ±è¡¨è¼¸å‡º | ğŸ’¾ æ”¯æ´æš«å­˜æª”åŠŸèƒ½</p>
        </div>

        <!-- ç·¨è¼¯æƒæè¨˜éŒ„å½ˆå‡ºè¦–çª— -->
        <div id="editScanModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>âœï¸ ç·¨è¼¯æƒæè¨˜éŒ„</h2>
                    <span class="close" onclick="closeEditScanModal()">&times;</span>
                </div>
                
                <form id="editScanForm">
                    <div class="form-group">
                        <label class="form-label">èº«ä»½è­‰å­—è™Ÿ *</label>
                        <input type="text" id="editIdCard" class="form-input" required maxlength="10" 
                               placeholder="è«‹è¼¸å…¥æ­£ç¢ºçš„èº«ä»½è­‰å­—è™Ÿ">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">å§“å *</label>
                        <input type="text" id="editName" class="form-input" required 
                               placeholder="è«‹è¼¸å…¥æ­£ç¢ºçš„å§“å">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">æƒææ™‚é–“</label>
                        <input type="datetime-local" id="editScanTime" class="form-input">
                        <small style="color: #6c757d; margin-top: 5px; display: block;">
                            ğŸ’¡ å¦‚æœä¸ä¿®æ”¹æ™‚é–“ï¼Œè«‹ä¿æŒåŸè¨­å®š
                        </small>
                    </div>
                    
                    <div style="text-align: right; margin-top: 30px;">
                        <button type="button" class="btn btn-danger" onclick="closeEditScanModal()">
                            âŒ å–æ¶ˆ
                        </button>
                        <button type="submit" class="btn btn-success">
                            âœ… å„²å­˜ä¿®æ”¹
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- åˆ†é æ¨™ç±¤ -->
        <div class="tabs">
            <button class="tab active" onclick="switchTab('setup')">ğŸ“‹ èª²ç¨‹è¨­å®š</button>
            <button class="tab" onclick="switchTab('import')">ğŸ“¥ å§“ååŒ¯å…¥</button>
            <button class="tab" onclick="switchTab('scan')">ğŸ“± èº«ä»½è­‰æƒæ</button>
            <button class="tab" onclick="switchTab('report')">ğŸ“Š å®Œæ•´å ±è¡¨</button>
            <button class="tab" onclick="switchTab('temp')">ğŸ’¾ æš«å­˜æª”ç®¡ç†</button>
        </div>

        <!-- èª²ç¨‹è¨­å®šé é¢ -->
        <div id="setup" class="tab-content active">
            <h2>ğŸ“‹ èª²ç¨‹è³‡æ–™è¨­å®š</h2>
            <div class="status-panel">
                <div class="status-info">
                    <div class="status-item">
                        <div class="status-indicator"></div>
                        <span><strong>èª²ç¨‹è¨­å®šç‹€æ…‹:</strong> <span id="courseStatus">æœªè¨­å®š</span></span>
                    </div>
                </div>
            </div>

            <div class="info-card">
                <h3>ğŸ“ ç•¶å‰èª²ç¨‹è³‡æ–™</h3>
                <div id="courseInfo">
                    <p class="empty-state">
                        <span class="empty-icon">ğŸ“š</span><br>
                        å°šæœªè¨­å®šèª²ç¨‹è³‡æ–™<br>
                        è«‹é»æ“Šä¸‹æ–¹æŒ‰éˆ•é–‹å§‹è¨­å®š
                    </p>
                </div>
            </div>

            <button class="btn btn-primary" onclick="openCourseModal()">
                ğŸ†• è¨­å®šèª²ç¨‹è³‡æ–™
            </button>
            <button class="btn btn-info" onclick="editCourseData()" id="editCourseBtn" style="display: none;">
                âœï¸ ç·¨è¼¯èª²ç¨‹è³‡æ–™
            </button>
        </div>

        <!-- å§“ååŒ¯å…¥é é¢ -->
        <div id="import" class="tab-content">
            <h2>ğŸ“¥ èº«ä»½è­‰èˆ‡å§“åå°æ‡‰è¡¨åŒ¯å…¥</h2>
            <div class="status-panel">
                <div class="status-info">
                    <div class="status-item">
                        <span><strong>å·²åŒ¯å…¥äººæ•¸:</strong> <span id="importedCount">0</span> äºº</span>
                    </div>
                </div>
            </div>

            <div class="info-card">
                <h3>ğŸ“¤ åŒ¯å…¥Excelæª”æ¡ˆ</h3>
                <p>è«‹é¸æ“‡åŒ…å«èº«ä»½è­‰å­—è™Ÿå’Œå§“åçš„Excelæª”æ¡ˆ</p>
                <div style="margin-top: 15px;">
                    <button class="btn btn-success" onclick="triggerFileUpload()">
                        ğŸ“‚ é¸æ“‡æª”æ¡ˆåŒ¯å…¥
                    </button>
                    <input type="file" id="nameFileInput" accept=".xlsx,.xls,.csv" onchange="importNameFile()" style="display: none;">
                </div>
                <small style="color: #6c757d; margin-top: 10px; display: block;">
                    ğŸ’¡ æ”¯æ´æ ¼å¼ï¼šExcel (.xlsx, .xls) æˆ– CSV (.csv)<br>
                    ğŸ“‹ æª”æ¡ˆæ‡‰åŒ…å«ã€Œèº«ä»½è­‰å­—è™Ÿã€å’Œã€Œå§“åã€å…©å€‹æ¬„ä½
                </small>
            </div>

            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>èº«ä»½è­‰å­—è™Ÿ</th>
                            <th>å§“å</th>
                            <th>åŒ¯å…¥æ™‚é–“</th>
                        </tr>
                    </thead>
                    <tbody id="nameTableBody">
                        <tr>
                            <td colspan="3" class="empty-state">
                                <div class="empty-icon">ğŸ‘¥</div>
                                <h3>å°šæœªåŒ¯å…¥å§“åè³‡æ–™</h3>
                                <p>è«‹é¸æ“‡Excelæª”æ¡ˆåŒ¯å…¥èº«ä»½è­‰èˆ‡å§“åå°æ‡‰è¡¨</p>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- èº«ä»½è­‰æƒæé é¢ -->
        <div id="scan" class="tab-content">
            <h2>ğŸ“± èº«ä»½è­‰æƒæ</h2>
            <div class="status-panel">
                <div class="status-info">
                    <div class="status-item">
                        <div class="status-indicator"></div>
                        <span><strong>æƒæå™¨ç‹€æ…‹:</strong> å°±ç·’</span>
                    </div>
                    <div class="status-item">
                        <span><strong>å·²æƒæäººæ•¸:</strong> <span id="scannedCount">0</span> äºº</span>
                    </div>
                    <div class="status-item">
                        <span><strong>æœ€å¾Œæƒæ:</strong> <span id="lastScan">å°šæœªæƒæ</span></span>
                    </div>
                </div>
            </div>

            <div class="scanner-section">
                <h3>ğŸ” æƒæèº«ä»½è­‰</h3>
                <div class="scanner-input">
                    <input type="text" id="idCardInput" class="form-input" placeholder="è«‹æƒæèº«ä»½è­‰æˆ–æ‰‹å‹•è¼¸å…¥..." autofocus>
                    <button class="btn btn-primary" onclick="addScannedId()">æ–°å¢</button>
                </div>
                <small style="color: #6c757d; margin-top: 10px; display: block;">
                    ğŸ’¡ æç¤º: é€£æ¥æƒæå™¨å¾Œï¼Œæƒæçš„èº«ä»½è­‰æœƒè‡ªå‹•å‡ºç¾åœ¨è¼¸å…¥æ¡†ä¸­<br>
                    âš ï¸ é‡è¦: è«‹ç¢ºä¿è¼¸å…¥æ³•ç‚º<strong>è‹±æ–‡æ¨¡å¼</strong>ï¼Œé¿å…å­—ç¬¦è¢«è½‰æ›<br>
                    âœï¸ ç·¨è¼¯: å¦‚æœæƒæçš„èº«ä»½è­‰æ²’æœ‰å°æ‡‰å§“åï¼Œå¯ä»¥é»æ“Šã€Œç·¨è¼¯ã€æŒ‰éˆ•æ‰‹å‹•ä¿®æ”¹
                </small>
            </div>

            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>åºè™Ÿ</th>
                            <th>èº«ä»½è­‰å­—è™Ÿ</th>
                            <th>å§“å</th>
                            <th>æƒææ™‚é–“</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="scanTableBody">
                        <tr>
                            <td colspan="5" class="empty-state">
                                <div class="empty-icon">ğŸ“±</div>
                                <h3>å°šç„¡æƒææ•¸æ“š</h3>
                                <p>è«‹ä½¿ç”¨æ¢ç¢¼æƒæå™¨æƒæèº«ä»½è­‰ï¼Œæˆ–æ‰‹å‹•è¼¸å…¥</p>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div style="margin-top: 20px;">
                <button class="btn btn-danger" onclick="clearScanData()">
                    ğŸ—‘ï¸ æ¸…é™¤æƒææ•¸æ“š
                </button>
            </div>
        </div>

        <!-- å®Œæ•´å ±è¡¨é é¢ -->
        <div id="report" class="tab-content">
            <h2>ğŸ“Š å®Œæ•´å ±è¡¨</h2>
            <div class="status-panel">
                <div class="status-info">
                    <div class="status-item">
                        <span><strong>å ±è¡¨è¨˜éŒ„æ•¸:</strong> <span id="reportCount">0</span> ç­†</span>
                    </div>
                </div>
            </div>

            <div style="margin-bottom: 20px;">
                <!-- <button class="btn btn-success" onclick="exportFullReport()">
                    ğŸ“¥ åŒ¯å‡ºå®Œæ•´å ±è¡¨
                </button> -->
                <button class="btn btn-info" onclick="exportAsCSV1()">
                    ğŸ“„ åŒ¯å‡ºç‚ºæœªé–‹èª²CSV
                </button>
                <button class="btn btn-info" onclick="exportAsCSV2()">
                    ğŸ“„ åŒ¯å‡ºç‚ºå·²é–‹èª²CSV
                </button>
                <label style="margin-left: 20px; display: inline-flex; align-items: center; gap: 8px;">
                    <input type="checkbox" id="includeScanTime" checked>
                    <span>åŒ…å«æƒææ™‚é–“æ¬„ä½</span>
                </label>
            </div>
            
            <div id="downloadStatus" style="display: none;" class="download-status">
                <div id="downloadMessage"></div>
            </div>

            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>èº«ä»½è­‰å­—è™Ÿ</th>
                            <th>èª²ç¨‹åç¨±</th>
                            <th>é–‹èª²èµ·å§‹æ—¥æœŸ</th>
                            <th>é–‹èª²èµ·å§‹æ™‚é–“</th>
                            <th>é–‹èª²çµæŸæ—¥æœŸ</th>
                            <th>é–‹èª²çµæŸæ™‚é–“</th>
                            <th>å§“å</th>
                            <th>å­¸ä½å­¸åˆ†</th>
                            <th>èª²ç¨‹é¡åˆ¥ä»£ç¢¼</th>
                            <th>ä¸Šèª²ç¸£å¸‚</th>
                            <th>æƒææ™‚é–“</th>
                        </tr>
                    </thead>
                    <tbody id="reportTableBody">
                        <tr>
                            <td colspan="11" class="empty-state">
                                <div class="empty-icon">ğŸ“‹</div>
                                <h3>å°šç„¡å ±è¡¨æ•¸æ“š</h3>
                                <p>è«‹å…ˆå®Œæˆèª²ç¨‹è¨­å®šã€å§“ååŒ¯å…¥å’Œèº«ä»½è­‰æƒæ</p>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- æš«å­˜æª”ç®¡ç†é é¢ -->
        <div id="temp" class="tab-content">
            
            <div class="temp-save-section">
                <h3>ğŸ’¾ æš«å­˜æª”åŠŸèƒ½</h3>
                <p>æ‚¨å¯ä»¥éš¨æ™‚ä¿å­˜ç•¶å‰çš„å·¥ä½œç‹€æ…‹ï¼ŒåŒ…æ‹¬èª²ç¨‹è¨­å®šã€å§“åè³‡æ–™å’Œæƒæè¨˜éŒ„ã€‚</p>
                
                <div class="temp-save-buttons">
                    <button class="btn btn-warning" onclick="saveTempFile()">
                        ğŸ’¾ å„²å­˜æš«å­˜æª”
                    </button>
                    <button class="btn btn-info" onclick="triggerTempFileUpload()">
                        ğŸ“‚ è¼‰å…¥æš«å­˜æª”
                    </button>
                    <input type="file" id="tempFileInput" accept=".json" onchange="loadTempFile()" style="display: none;">
                </div>

                <div class="temp-file-info" id="tempFileInfo" style="display: none;">
                    <h4>ğŸ“„ æš«å­˜æª”è³‡è¨Š</h4>
                    <div id="tempFileDetails"></div>
                </div>
            </div>

            <div class="info-card">
                <h3>ğŸ“Š ç•¶å‰ç‹€æ…‹æ¦‚è¦½</h3>
                <div id="currentStatusOverview">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-top: 15px;">
                        <div style="background: #e3f2fd; padding: 15px; border-radius: 8px;">
                            <strong>èª²ç¨‹è¨­å®š:</strong> <span id="statusCourse">æœªè¨­å®š</span>
                        </div>
                        <div style="background: #f3e5f5; padding: 15px; border-radius: 8px;">
                            <strong>åŒ¯å…¥å§“å:</strong> <span id="statusNames">0 äºº</span>
                        </div>
                        <div style="background: #e8f5e8; padding: 15px; border-radius: 8px;">
                            <strong>æƒæè¨˜éŒ„:</strong> <span id="statusScans">0 ç­†</span>
                        </div>
                        <div style="background: #fff3e0; padding: 15px; border-radius: 8px;">
                            <strong>å®Œæˆåº¦:</strong> <span id="statusProgress">0%</span>
                            <div class="progress-indicator">
                                <div class="progress-bar" id="progressBar" style="width: 0%;"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="info-card">
                <h3>ğŸ“‹ æš«å­˜æª”ä½¿ç”¨èªªæ˜</h3>
                <ul style="line-height: 1.8; color: #666; margin-left: 20px;">
                    <li><strong>å„²å­˜æš«å­˜æª”:</strong> å°‡ç•¶å‰æ‰€æœ‰è³‡æ–™ï¼ˆèª²ç¨‹è¨­å®šã€å§“åå°æ‡‰è¡¨ã€æƒæè¨˜éŒ„ï¼‰ä¿å­˜ç‚º JSON æª”æ¡ˆ</li>
                    <li><strong>è¼‰å…¥æš«å­˜æª”:</strong> å¾ä¹‹å‰å„²å­˜çš„ JSON æª”æ¡ˆä¸­æ¢å¾©æ‰€æœ‰è³‡æ–™ï¼Œå›åˆ°ä¸Šæ¬¡çš„å·¥ä½œç‹€æ…‹</li>
                    <li><strong>è‡ªå‹•å‘½å:</strong> æš«å­˜æª”æœƒè‡ªå‹•ä»¥èª²ç¨‹åç¨±å’Œæ™‚é–“å‘½åï¼Œæ–¹ä¾¿è­˜åˆ¥</li>
                    <li><strong>æ•¸æ“šå®Œæ•´æ€§:</strong> æš«å­˜æª”åŒ…å«æ‰€æœ‰å¿…è¦è³‡è¨Šï¼Œç¢ºä¿è¼‰å…¥å¾ŒåŠŸèƒ½å®Œå…¨æ­£å¸¸</li>
                    <li><strong>å¿«æ·éµ:</strong> ä½¿ç”¨ Ctrl+Shift+S å¿«é€Ÿå„²å­˜æš«å­˜æª”</li>
                </ul>
            </div>

            <div style="margin-top: 20px;">
                <button class="btn btn-danger" onclick="clearAllData()">
                    ğŸ—‘ï¸ æ¸…é™¤æ‰€æœ‰è³‡æ–™
                </button>
                <small style="color: #dc3545; margin-left: 10px;">âš ï¸ æ­¤æ“ä½œæœƒæ¸…é™¤æ‰€æœ‰è³‡æ–™ï¼Œå»ºè­°å…ˆå„²å­˜æš«å­˜æª”</small>
            </div>
        </div>
    </div>

    <!-- èª²ç¨‹è¨­å®šå½ˆå‡ºè¦–çª— -->
    <div id="courseModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>ğŸ“‹ èª²ç¨‹è³‡æ–™è¨­å®š</h2>
                <span class="close" onclick="closeCourseModal()">&times;</span>
            </div>
            
            <form id="courseForm">
                <div class="form-group">
                    <label class="form-label">èª²ç¨‹åç¨± *</label>
                    <input type="text" id="courseName" class="form-input" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label">é–‹èª²èµ·å§‹æ—¥æœŸ *</label>
                    <input type="date" id="startDate" class="form-input" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label">é–‹èª²èµ·å§‹æ™‚é–“ *</label>
                    <input type="time" id="startTime" class="form-input" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label">é–‹èª²çµæŸæ—¥æœŸ *</label>
                    <input type="date" id="endDate" class="form-input" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label">é–‹èª²çµæŸæ™‚é–“ *</label>
                    <input type="time" id="endTime" class="form-input" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label">å­¸ä½å­¸åˆ†</label>
                    <input type="number" id="credits" class="form-input" min="0" step="0.1">
                </div>
                
                <div class="form-group">
                    <label class="form-label">èª²ç¨‹é¡åˆ¥ä»£ç¢¼</label>
                    <input type="text" id="courseCode" class="form-input">
                </div>
                
                <div class="form-group">
                    <label class="form-label">ä¸Šèª²ç¸£å¸‚</label>
                    <input type="text" id="city" class="form-input">
                </div>
                
                <div class="form-group">
                    <label class="form-label">æœŸåˆ¥</label>
                    <input type="text" id="period" class="form-input" >
                </div>
                
                <div class="form-group">
                    <label class="form-label">è¨“ç·´ç¸½æ•¸</label>
                    <input type="number" id="trainingTotal" class="form-input" min="1" step="1" >
                </div>
                
                <div class="form-group">
                    <label class="form-label">è¨“ç·´ç¸½æ•¸å–®ä½</label>
                    <input type="text" id="trainingUnit" class="form-input" >
                </div>
                
                <div class="form-group">
                    <label class="form-label">å­¸ç¿’æ€§è³ª</label>
                    <input type="text" id="learningType" class="form-input" >
                </div>
                
                <div class="form-group">
                    <label class="form-label">æ•¸ä½æ™‚æ•¸</label>
                    <input type="number" id="digitalHours" class="form-input" min="0" step="0.1" >
                </div>
                
                <div class="form-group">
                    <label class="form-label">å¯¦é«”æ™‚æ•¸</label>
                    <input type="number" id="physicalHours" class="form-input" min="0" step="0.1" >
                </div>
                
                <div style="text-align: right; margin-top: 30px;">
                    <button type="button" class="btn btn-danger" onclick="closeCourseModal()">
                        âŒ å–æ¶ˆ
                    </button>
                    <button type="submit" class="btn btn-success">
                        âœ… å„²å­˜èª²ç¨‹è³‡æ–™
                    </button>
                </div>
            </form>
        </div>
    </div>

    <div id="notification" class="notification"></div>

    <script>
        // å…¨åŸŸè®Šæ•¸
        let courseData = null;
        let nameMapping = new Map(); // èº«ä»½è­‰ -> å§“åçš„å°æ‡‰è¡¨
        let scannedIds = [];
        let sequenceNumber = 1;

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            initScanner();
            loadSavedData();
            updateStatusOverview();
        });

        // åˆ†é åˆ‡æ›
        function switchTab(tabName) {
            // éš±è—æ‰€æœ‰åˆ†é å…§å®¹
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // ç§»é™¤æ‰€æœ‰åˆ†é çš„activeç‹€æ…‹
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // é¡¯ç¤ºé¸ä¸­çš„åˆ†é 
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
            
            // æ›´æ–°ç›¸é—œæ•¸æ“šé¡¯ç¤º
            updateAllDisplays();
            if (tabName === 'temp') {
                updateStatusOverview();
            }
        }

        // åˆå§‹åŒ–æƒæå™¨
        function initScanner() {
            const input = document.getElementById('idCardInput');
           
            input.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    addScannedId();
                }
            });
        }

        // èª²ç¨‹è¨­å®šç›¸é—œåŠŸèƒ½
        function openCourseModal() {
            document.getElementById('courseModal').classList.add('show');
            
            // å¦‚æœå·²æœ‰èª²ç¨‹è³‡æ–™ï¼Œå¡«å…¥è¡¨å–®
            if (courseData) {
                document.getElementById('courseName').value = courseData.courseName || '';
                document.getElementById('startDate').value = courseData.startDate || '';
                document.getElementById('startTime').value = courseData.startTime || '';
                document.getElementById('endDate').value = courseData.endDate || '';
                document.getElementById('endTime').value = courseData.endTime || '';
                document.getElementById('credits').value = courseData.credits || '';
                document.getElementById('courseCode').value = courseData.courseCode || '';
                document.getElementById('city').value = courseData.city || '';
                document.getElementById('period').value = courseData.period || '';
                document.getElementById('trainingTotal').value = courseData.trainingTotal || '';
                document.getElementById('trainingUnit').value = courseData.trainingUnit || '';
                document.getElementById('learningType').value = courseData.learningType || '';
                document.getElementById('digitalHours').value = courseData.digitalHours || '';
                document.getElementById('physicalHours').value = courseData.physicalHours || '';
            }
        }

        function closeCourseModal() {
            document.getElementById('courseModal').classList.remove('show');
        }

        function editCourseData() {
            openCourseModal();
        }

        // è§¸ç™¼æª”æ¡ˆä¸Šå‚³
        function triggerFileUpload() {
            document.getElementById('nameFileInput').click();
        }

        // èª²ç¨‹è¡¨å–®æäº¤
        document.getElementById('courseForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            courseData = {
                courseName: document.getElementById('courseName').value,
                startDate: document.getElementById('startDate').value,
                startTime: document.getElementById('startTime').value,
                endDate: document.getElementById('endDate').value,
                endTime: document.getElementById('endTime').value,
                credits: document.getElementById('credits').value,
                courseCode: document.getElementById('courseCode').value,
                city: document.getElementById('city').value,
                period: document.getElementById('period').value,
                trainingTotal: document.getElementById('trainingTotal').value,
                trainingUnit: document.getElementById('trainingUnit').value,
                learningType: document.getElementById('learningType').value,
                digitalHours: document.getElementById('digitalHours').value,
                physicalHours: document.getElementById('physicalHours').value,
                createdAt: new Date().toLocaleString('zh-TW')
            };
            
            updateCourseDisplay();
            closeCourseModal();
            showNotification('èª²ç¨‹è³‡æ–™å·²æˆåŠŸå„²å­˜ï¼', 'success');
            saveDataToStorage();
            updateStatusOverview();
        });

        // æ›´æ–°èª²ç¨‹é¡¯ç¤º
        function updateCourseDisplay() {
            const courseInfo = document.getElementById('courseInfo');
            const courseStatus = document.getElementById('courseStatus');
            const editBtn = document.getElementById('editCourseBtn');
            
            if (courseData) {
                courseStatus.textContent = 'å·²è¨­å®š';
                editBtn.style.display = 'inline-flex';
                
                courseInfo.innerHTML = `
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
                        <div><strong>èª²ç¨‹åç¨±:</strong> ${courseData.courseName}</div>
                        <div><strong>é–‹å§‹æ—¥æœŸ:</strong> ${courseData.startDate}</div>
                        <div><strong>é–‹å§‹æ™‚é–“:</strong> ${courseData.startTime}</div>
                        <div><strong>çµæŸæ—¥æœŸ:</strong> ${courseData.endDate}</div>
                        <div><strong>çµæŸæ™‚é–“:</strong> ${courseData.endTime}</div>
                        <div><strong>å­¸ä½å­¸åˆ†:</strong> ${courseData.credits || 'æœªè¨­å®š'}</div>
                        <div><strong>èª²ç¨‹ä»£ç¢¼:</strong> ${courseData.courseCode || 'æœªè¨­å®š'}</div>
                        <div><strong>ä¸Šèª²ç¸£å¸‚:</strong> ${courseData.city || 'æœªè¨­å®š'}</div>
                        <div><strong>æœŸåˆ¥:</strong> ${courseData.period || 'æœªè¨­å®š'}</div>
                        <div><strong>è¨“ç·´ç¸½æ•¸:</strong> ${courseData.trainingTotal || 'æœªè¨­å®š'} </div>
                        <div><strong>è¨“ç·´ç¸½æ•¸å–®ä½:</strong> ${courseData.trainingUnit || 'æœªè¨­å®š'}</div>
                        <div><strong>å­¸ç¿’æ€§è³ª:</strong> ${courseData.learningType || 'æœªè¨­å®š'}</div>
                        <div><strong>æ•¸ä½æ™‚æ•¸:</strong> ${courseData.digitalHours || '0'} å°æ™‚</div>
                        <div><strong>å¯¦é«”æ™‚æ•¸:</strong> ${courseData.physicalHours || '0'} å°æ™‚</div>
                    </div>
                `;
            } else {
                courseStatus.textContent = 'æœªè¨­å®š';
                editBtn.style.display = 'none';
                courseInfo.innerHTML = `
                    <p class="empty-state">
                        <span class="empty-icon">ğŸ“š</span><br>
                        å°šæœªè¨­å®šèª²ç¨‹è³‡æ–™<br>
                        è«‹é»æ“Šä¸‹æ–¹æŒ‰éˆ•é–‹å§‹è¨­å®š
                    </p>
                `;
            }
        }

        // å§“åæª”æ¡ˆåŒ¯å…¥
        function importNameFile() {
            const fileInput = document.getElementById('nameFileInput');
            const file = fileInput.files[0];
            
            if (!file) {
                showNotification('è«‹é¸æ“‡æª”æ¡ˆ', 'error');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    let data;
                    const fileName = file.name.toLowerCase();
                    
                    if (fileName.endsWith('.csv')) {
                        // è™•ç†CSVæª”æ¡ˆ
                        const csvText = e.target.result;
                        data = parseCSV(csvText);
                    } else if (fileName.endsWith('.xlsx') || fileName.endsWith('.xls')) {
                        // è™•ç†Excelæª”æ¡ˆ
                        const workbook = XLSX.read(e.target.result, { type: 'binary' });
                        const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                        data = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });
                    }
                    
                    processNameData(data);
                } catch (error) {
                    console.error('æª”æ¡ˆè§£æéŒ¯èª¤:', error);
                    showNotification('æª”æ¡ˆæ ¼å¼éŒ¯èª¤ï¼Œè«‹æª¢æŸ¥æª”æ¡ˆå…§å®¹', 'error');
                }
            };
            
            if (file.name.toLowerCase().endsWith('.csv')) {
                reader.readAsText(file, 'UTF-8');
            } else {
                reader.readAsBinaryString(file);
            }
        }

        // è§£æCSV
        function parseCSV(csvText) {
            const lines = csvText.split('\n');
            const result = [];
            
            for (let line of lines) {
                if (line.trim()) {
                    const values = line.split(',').map(value => value.trim().replace(/"/g, ''));
                    result.push(values);
                }
            }
            
            return result;
        }

        // è™•ç†å§“åæ•¸æ“š
        function processNameData(data) {
            if (!data || data.length < 2) {
                showNotification('æª”æ¡ˆå…§å®¹ä¸è¶³ï¼Œè«‹ç¢ºèªæª”æ¡ˆæ ¼å¼', 'error');
                return;
            }

            // æ¸…ç©ºç¾æœ‰çš„å§“åå°æ‡‰è¡¨
            nameMapping.clear();
            
            // å°‹æ‰¾èº«ä»½è­‰å­—è™Ÿå’Œå§“åæ¬„ä½
            const headers = data[0];
            let idIndex = -1;
            let nameIndex = -1;
            
            // å°‹æ‰¾å¯èƒ½çš„æ¬„ä½åç¨±
            for (let i = 0; i < headers.length; i++) {
                const header = headers[i].toString().toLowerCase();
                if (header.includes('èº«ä»½è­‰') || header.includes('èº«åˆ†è­‰') || header.includes('id') || 
                    header.includes('è­‰è™Ÿ') || header.includes('IDCard')) {
                    idIndex = i;
                }
                if (header.includes('å§“å') || header.includes('name') || header.includes('åå­—')) {
                    nameIndex = i;
                }
            }
            
            // å¦‚æœæ‰¾ä¸åˆ°æ¬„ä½ï¼Œå‡è¨­å‰å…©æ¬„æ˜¯èº«ä»½è­‰å’Œå§“å
            if (idIndex === -1) idIndex = 0;
            if (nameIndex === -1) nameIndex = 1;
            
            let importCount = 0;
            
            // è™•ç†æ•¸æ“šè¡Œ
            for (let i = 1; i < data.length; i++) {
                const row = data[i];
                if (row.length > Math.max(idIndex, nameIndex)) {
                    const id = row[idIndex]?.toString().trim();
                    const name = row[nameIndex]?.toString().trim();
                    
                    if (id && name && id.length >= 8) { // åŸºæœ¬çš„èº«ä»½è­‰æ ¼å¼æª¢æŸ¥
                        nameMapping.set(id, {
                            name: name,
                            importTime: new Date().toLocaleString('zh-TW')
                        });
                        importCount++;
                    }
                }
            }
            
            if (importCount > 0) {
                updateNameTable();
                showNotification(`æˆåŠŸåŒ¯å…¥ ${importCount} ç­†å§“åè³‡æ–™`, 'success');
                saveDataToStorage();
                updateStatusOverview();
            } else {
                showNotification('æœªæ‰¾åˆ°æœ‰æ•ˆçš„èº«ä»½è­‰å’Œå§“åè³‡æ–™', 'error');
            }
            
            // æ¸…ç©ºæª”æ¡ˆè¼¸å…¥
            document.getElementById('nameFileInput').value = '';
        }

        // æ›´æ–°å§“åè¡¨æ ¼
        function updateNameTable() {
            const tbody = document.getElementById('nameTableBody');
            const importedCount = document.getElementById('importedCount');
            
            importedCount.textContent = nameMapping.size;
            
            if (nameMapping.size === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="3" class="empty-state">
                            <div class="empty-icon">ğŸ‘¥</div>
                            <h3>å°šæœªåŒ¯å…¥å§“åè³‡æ–™</h3>
                            <p>è«‹é¸æ“‡Excelæª”æ¡ˆåŒ¯å…¥èº«ä»½è­‰èˆ‡å§“åå°æ‡‰è¡¨</p>
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = Array.from(nameMapping.entries()).map(([id, data]) => `
                <tr>
                    <td><code>${id}</code></td>
                    <td><strong>${data.name}</strong></td>
                    <td>${data.importTime}</td>
                </tr>
            `).join('');
        }

        // æ·»åŠ æƒæçš„èº«ä»½è­‰
        function addScannedId(idValue) {
            const input = document.getElementById('idCardInput');
            const id = idValue || input.value.trim();
            
            if (!id) {
                showNotification('è«‹è¼¸å…¥èº«ä»½è­‰å­—è™Ÿ', 'error');
                return;
            }
            
            // åŸºæœ¬èº«ä»½è­‰æ ¼å¼æª¢æŸ¥
            if (id.length != 10) {
                showNotification('èº«ä»½è­‰å­—è™Ÿæ ¼å¼ä¸æ­£ç¢º', 'error');
                input.value = '';
                return;
            }
            
            // æª¢æŸ¥æ˜¯å¦å·²æƒæé
            if (scannedIds.some(item => item.id === id)) {
                showNotification('æ­¤èº«ä»½è­‰å·²æƒæé', 'error');
                input.value = '';
                return;
            }
            
            const currentTime = new Date().toLocaleString('zh-TW');
            const nameData = nameMapping.get(id);
            
            const newEntry = {
                sequence: sequenceNumber++,
                id: id,
                name: nameData ? nameData.name : 'å§“åæœªåŒ¯å…¥',
                scanTime: currentTime,
                timestamp: Date.now()
            };
            
            scannedIds.push(newEntry);
            updateScanTable();
            updateReportTable();
            showNotification(`å·²æ–°å¢: ${newEntry.name} (${id})`, 'success');
            saveDataToStorage();
            updateStatusOverview();
            
            if (!idValue) {
                input.value = '';
                input.focus();
            }
        }

        // æ›´æ–°æƒæè¡¨æ ¼
        function updateScanTable() {
            const tbody = document.getElementById('scanTableBody');
            const scannedCount = document.getElementById('scannedCount');
            const lastScan = document.getElementById('lastScan');
            
            scannedCount.textContent = scannedIds.length;
            
            if (scannedIds.length > 0) {
                const lastItem = scannedIds[scannedIds.length - 1];
                lastScan.textContent = lastItem.scanTime;
            }
            
            if (scannedIds.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="5" class="empty-state">
                            <div class="empty-icon">ğŸ“±</div>
                            <h3>å°šç„¡æƒææ•¸æ“š</h3>
                            <p>è«‹ä½¿ç”¨æ¢ç¢¼æƒæå™¨æƒæèº«ä»½è­‰ï¼Œæˆ–æ‰‹å‹•è¼¸å…¥</p>
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = scannedIds.map(item => `
                <tr>
                    <td><strong>#${item.sequence}</strong></td>
                    <td><code>${item.id}</code></td>
                    <td><strong>${item.name}</strong></td>
                    <td>${item.scanTime}</td>
                    <td class="edit-buttons">
                        <button class="btn btn-info" onclick="editScanItem(${item.timestamp})">
                            âœï¸ ç·¨è¼¯
                        </button>
                        <button class="btn btn-danger" onclick="deleteScanItem(${item.timestamp})">
                            ğŸ—‘ï¸ åˆªé™¤
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        // ç·¨è¼¯æƒæé …ç›®
        let editingItemTimestamp = null;

        function editScanItem(timestamp) {
            const item = scannedIds.find(item => item.timestamp === timestamp);
            if (!item) {
                showNotification('æ‰¾ä¸åˆ°è¦ç·¨è¼¯çš„è¨˜éŒ„', 'error');
                return;
            }
            
            editingItemTimestamp = timestamp;
            
            // å¡«å…¥ç¾æœ‰è³‡æ–™åˆ°ç·¨è¼¯è¡¨å–®
            document.getElementById('editIdCard').value = item.id;
            document.getElementById('editName').value = item.name;
            
            // å°‡æ™‚é–“æ ¼å¼è½‰æ›ç‚º datetime-local æ ¼å¼
            try {
                // è§£æå°ç£æ™‚é–“æ ¼å¼ (ä¾‹å¦‚: 2024/6/5 ä¸‹åˆ3:30:45)
                const timeString = item.scanTime;
                let dateObj;
                
                // å˜—è©¦ä¸åŒçš„æ™‚é–“æ ¼å¼è§£æ
                if (timeString.includes('/')) {
                    // å°ç£æ ¼å¼: 2024/6/5 ä¸‹åˆ3:30:45
                    const parts = timeString.split(' ');
                    const datePart = parts[0]; // 2024/6/5
                    const timePart = parts.length > 1 ? parts.slice(1).join(' ') : ''; // ä¸‹åˆ3:30:45
                    
                    // è™•ç†æ—¥æœŸéƒ¨åˆ†
                    const dateComponents = datePart.split('/');
                    if (dateComponents.length === 3) {
                        let year = parseInt(dateComponents[0]);
                        let month = parseInt(dateComponents[1]) - 1; // JavaScript æœˆä»½å¾0é–‹å§‹
                        let day = parseInt(dateComponents[2]);
                        
                        let hour = 0, minute = 0, second = 0;
                        
                        // è™•ç†æ™‚é–“éƒ¨åˆ†
                        if (timePart) {
                            const timeRegex = /(\d{1,2}):(\d{1,2}):(\d{1,2})/;
                            const timeMatch = timePart.match(timeRegex);
                            if (timeMatch) {
                                hour = parseInt(timeMatch[1]);
                                minute = parseInt(timeMatch[2]);
                                second = parseInt(timeMatch[3]);
                                
                                // è™•ç†ä¸Šåˆ/ä¸‹åˆ
                                if (timePart.includes('ä¸‹åˆ') && hour !== 12) {
                                    hour += 12;
                                } else if (timePart.includes('ä¸Šåˆ') && hour === 12) {
                                    hour = 0;
                                }
                            }
                        }
                        
                        dateObj = new Date(year, month, day, hour, minute, second);
                    }
                } else {
                    // å˜—è©¦ç›´æ¥è§£æ
                    dateObj = new Date(timeString);
                }
                
                // å¦‚æœè§£ææˆåŠŸï¼Œè½‰æ›ç‚º datetime-local æ ¼å¼
                if (dateObj && !isNaN(dateObj.getTime())) {
                    // èª¿æ•´ç‚ºæœ¬åœ°æ™‚é–“
                    const offset = dateObj.getTimezoneOffset() * 60000;
                    const localISOTime = new Date(dateObj.getTime() - offset).toISOString();
                    const datetimeLocal = localISOTime.slice(0, 16); // ç§»é™¤ç§’æ•¸å’Œæ™‚å€éƒ¨åˆ†
                    document.getElementById('editScanTime').value = datetimeLocal;
                } else {
                    // å¦‚æœè§£æå¤±æ•—ï¼Œä½¿ç”¨ç•¶å‰æ™‚é–“
                    const now = new Date();
                    const offset = now.getTimezoneOffset() * 60000;
                    const localISOTime = new Date(now.getTime() - offset).toISOString();
                    document.getElementById('editScanTime').value = localISOTime.slice(0, 16);
                }
            } catch (error) {
                console.error('æ™‚é–“è§£æéŒ¯èª¤:', error);
                // ä½¿ç”¨ç•¶å‰æ™‚é–“ä½œç‚ºé è¨­å€¼
                const now = new Date();
                const offset = now.getTimezoneOffset() * 60000;
                const localISOTime = new Date(now.getTime() - offset).toISOString();
                document.getElementById('editScanTime').value = localISOTime.slice(0, 16);
            }
            
            // é¡¯ç¤ºç·¨è¼¯å½ˆå‡ºè¦–çª—
            document.getElementById('editScanModal').classList.add('show');
        }

        function closeEditScanModal() {
            document.getElementById('editScanModal').classList.remove('show');
            editingItemTimestamp = null;
        }

        // ç·¨è¼¯è¡¨å–®æäº¤è™•ç†
        document.getElementById('editScanForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            if (!editingItemTimestamp) {
                showNotification('æ²’æœ‰é¸ä¸­è¦ç·¨è¼¯çš„è¨˜éŒ„', 'error');
                return;
            }
            
            const newId = document.getElementById('editIdCard').value.trim();
            const newName = document.getElementById('editName').value.trim();
            const newScanTime = document.getElementById('editScanTime').value;
            
            // é©—è­‰å¿…å¡«æ¬„ä½
            if (!newId || !newName) {
                showNotification('èº«ä»½è­‰å­—è™Ÿå’Œå§“åç‚ºå¿…å¡«æ¬„ä½', 'error');
                return;
            }
            
            // é©—è­‰èº«ä»½è­‰æ ¼å¼
            if (newId.length < 8 || newId.length > 10) {
                showNotification('èº«ä»½è­‰å­—è™Ÿæ ¼å¼ä¸æ­£ç¢º', 'error');
                return;
            }
            
            // æª¢æŸ¥æ˜¯å¦èˆ‡å…¶ä»–è¨˜éŒ„çš„èº«ä»½è­‰é‡è¤‡
            const existingItem = scannedIds.find(item => 
                item.id === newId && item.timestamp !== editingItemTimestamp
            );
            
            if (existingItem) {
                showNotification('æ­¤èº«ä»½è­‰å­—è™Ÿå·²å­˜åœ¨å…¶ä»–è¨˜éŒ„ä¸­', 'error');
                return;
            }
            
            // æ‰¾åˆ°è¦ç·¨è¼¯çš„è¨˜éŒ„ä¸¦æ›´æ–°
            const itemIndex = scannedIds.findIndex(item => item.timestamp === editingItemTimestamp);
            if (itemIndex === -1) {
                showNotification('æ‰¾ä¸åˆ°è¦ç·¨è¼¯çš„è¨˜éŒ„', 'error');
                return;
            }
            
            // æ›´æ–°è¨˜éŒ„è³‡æ–™
            scannedIds[itemIndex].id = newId;
            scannedIds[itemIndex].name = newName;
            
            // æ›´æ–°æ™‚é–“ï¼ˆå¦‚æœæœ‰æä¾›æ–°æ™‚é–“ï¼‰
            if (newScanTime) {
                try {
                    const newDate = new Date(newScanTime);
                    if (!isNaN(newDate.getTime())) {
                        scannedIds[itemIndex].scanTime = newDate.toLocaleString('zh-TW');
                    }
                } catch (error) {
                    console.error('æ™‚é–“è½‰æ›éŒ¯èª¤:', error);
                    // å¦‚æœæ™‚é–“è½‰æ›å¤±æ•—ï¼Œä¿æŒåŸæ™‚é–“ä¸è®Š
                }
            }
            
            // æ›´æ–°ç•«é¢é¡¯ç¤º
            updateScanTable();
            updateReportTable();
            closeEditScanModal();
            showNotification(`è¨˜éŒ„å·²æˆåŠŸæ›´æ–°: ${newName} (${newId})`, 'success');
            saveDataToStorage();
        });

        function deleteScanItem(timestamp) {
            const item = scannedIds.find(item => item.timestamp === timestamp);
            if (!item) {
                showNotification('æ‰¾ä¸åˆ°è¦åˆªé™¤çš„è¨˜éŒ„', 'error');
                return;
            }
            
            if (confirm(`ç¢ºå®šè¦åˆªé™¤é€™ç­†æƒæè¨˜éŒ„å—ï¼Ÿ\n\nèº«ä»½è­‰: ${item.id}\nå§“å: ${item.name}\næƒææ™‚é–“: ${item.scanTime}`)) {
                scannedIds = scannedIds.filter(item => item.timestamp !== timestamp);
                updateScanTable();
                updateReportTable();
                showNotification('è¨˜éŒ„å·²åˆªé™¤', 'success');
                saveDataToStorage();
                updateStatusOverview();
            }
        }

        // æ¸…é™¤æƒææ•¸æ“š
        function clearScanData() {
            if (scannedIds.length === 0) {
                showNotification('æ²’æœ‰æ•¸æ“šéœ€è¦æ¸…é™¤', 'error');
                return;
            }

            if (confirm('ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰æƒææ•¸æ“šå—ï¼Ÿæ­¤æ“ä½œç„¡æ³•æ’¤éŠ·ï¼')) {
                scannedIds = [];
                sequenceNumber = 1;
                updateScanTable();
                updateReportTable();
                showNotification('æ‰€æœ‰æƒææ•¸æ“šå·²æ¸…é™¤', 'success');
                saveDataToStorage();
                updateStatusOverview();
            }
        }

        // æ›´æ–°å ±è¡¨è¡¨æ ¼
        function updateReportTable() {
            const tbody = document.getElementById('reportTableBody');
            const reportCount = document.getElementById('reportCount');
            
            reportCount.textContent = scannedIds.length;
            
            if (scannedIds.length === 0 || !courseData) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="11" class="empty-state">
                            <div class="empty-icon">ğŸ“‹</div>
                            <h3>å°šç„¡å ±è¡¨æ•¸æ“š</h3>
                            <p>è«‹å…ˆå®Œæˆèª²ç¨‹è¨­å®šã€å§“ååŒ¯å…¥å’Œèº«ä»½è­‰æƒæ</p>
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = scannedIds.map(item => `
                <tr>
                    <td><code>${item.id}</code></td>
                    <td>${courseData.courseName || ''}</td>
                    <td>${courseData.startDate || ''}</td>
                    <td>${courseData.startTime || ''}</td>
                    <td>${courseData.endDate || ''}</td>
                    <td>${courseData.endTime || ''}</td>
                    <td><strong>${item.name}</strong></td>
                    <td>${courseData.credits || ''}</td>
                    <td>${courseData.courseCode || ''}</td>
                    <td>${courseData.city || ''}</td>
                    <td>${item.scanTime}</td>
                </tr>
            `).join('');
        }

        // ===== æš«å­˜æª”åŠŸèƒ½ =====
        
        // å„²å­˜æš«å­˜æª”
        function saveTempFile() {
            try {
                // æº–å‚™è¦å„²å­˜çš„æ•¸æ“š
                const tempData = {
                    version: '1.0',
                    saveTime: new Date().toISOString(),
                    saveTimeLocal: new Date().toLocaleString('zh-TW'),
                    courseName: courseData ? courseData.courseName : 'æœªå‘½åèª²ç¨‹',
                    data: {
                        courseData: courseData,
                        nameMapping: Array.from(nameMapping.entries()),
                        scannedIds: scannedIds,
                        sequenceNumber: sequenceNumber
                    },
                    stats: {
                        courseSet: !!courseData,
                        nameCount: nameMapping.size,
                        scanCount: scannedIds.length
                    }
                };

                // è½‰æ›ç‚ºJSONå­—ä¸²
                const jsonContent = JSON.stringify(tempData, null, 2);

                // ç”Ÿæˆæª”æ¡ˆå
                const now = new Date();
                const dateStr = now.toISOString().slice(0, 10);
                const timeStr = now.toTimeString().slice(0, 8).replace(/:/g, '-');
                const courseName = courseData ? courseData.courseName.replace(/[^\w\u4e00-\u9fa5]/g, '_') : 'æœªå‘½åèª²ç¨‹';
                const filename = `${courseName}_æš«å­˜æª”_${dateStr}_${timeStr}.json`;

                // ä¸‹è¼‰æš«å­˜æª”
                const success = downloadFile(jsonContent, filename, 'application/json');
                
                if (success) {
                    showNotification(`æš«å­˜æª”å·²å„²å­˜: ${filename}`, 'success');
                    updateTempFileInfo(tempData);
                } else {
                    showNotification('æš«å­˜æª”å„²å­˜å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç€è¦½å™¨è¨­å®š', 'error');
                }

            } catch (error) {
                console.error('å„²å­˜æš«å­˜æª”æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
                showNotification('å„²å­˜æš«å­˜æª”æ™‚ç™¼ç”ŸéŒ¯èª¤: ' + error.message, 'error');
            }
        }

        // è§¸ç™¼æš«å­˜æª”ä¸Šå‚³
        function triggerTempFileUpload() {
            document.getElementById('tempFileInput').click();
        }

        // è¼‰å…¥æš«å­˜æª”
        function loadTempFile() {
            const fileInput = document.getElementById('tempFileInput');
            const file = fileInput.files[0];
            
            if (!file) {
                showNotification('è«‹é¸æ“‡æš«å­˜æª”', 'error');
                return;
            }

            if (!file.name.toLowerCase().endsWith('.json')) {
                showNotification('è«‹é¸æ“‡ JSON æ ¼å¼çš„æš«å­˜æª”', 'error');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const tempData = JSON.parse(e.target.result);
                    
                    // é©—è­‰æš«å­˜æª”æ ¼å¼
                    if (!tempData.version || !tempData.data) {
                        showNotification('æš«å­˜æª”æ ¼å¼ä¸æ­£ç¢º', 'error');
                        return;
                    }

                    // ç¢ºèªè¼‰å…¥æ“ä½œ
                    const confirmMessage = `ç¢ºå®šè¦è¼‰å…¥æš«å­˜æª”å—ï¼Ÿ\n\næª”æ¡ˆè³‡è¨Š:\n` +
                        `- èª²ç¨‹åç¨±: ${tempData.courseName}\n` +
                        `- å„²å­˜æ™‚é–“: ${tempData.saveTimeLocal}\n` +
                        `- å§“åè³‡æ–™: ${tempData.stats.nameCount} ç­†\n` +
                        `- æƒæè¨˜éŒ„: ${tempData.stats.scanCount} ç­†\n\n` +
                        `âš ï¸ é€™å°‡æœƒè¦†è“‹ç›®å‰æ‰€æœ‰è³‡æ–™ï¼`;

                    if (!confirm(confirmMessage)) {
                        fileInput.value = '';
                        return;
                    }

                    // è¼‰å…¥æ•¸æ“š
                    courseData = tempData.data.courseData;
                    nameMapping = new Map(tempData.data.nameMapping || []);
                    scannedIds = tempData.data.scannedIds || [];
                    sequenceNumber = tempData.data.sequenceNumber || 1;

                    // æ›´æ–°æ‰€æœ‰é¡¯ç¤º
                    updateAllDisplays();
                    updateStatusOverview();
                    updateTempFileInfo(tempData);

                    showNotification(`æš«å­˜æª”è¼‰å…¥æˆåŠŸ: ${tempData.courseName}`, 'success');
                    
                    // è‡ªå‹•åˆ‡æ›åˆ°ç¬¬ä¸€å€‹åˆ†é 
                    switchTab('setup');

                } catch (error) {
                    console.error('è¼‰å…¥æš«å­˜æª”æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
                    showNotification('æš«å­˜æª”æ ¼å¼éŒ¯èª¤æˆ–å·²æå£', 'error');
                }
            };
            
            reader.readAsText(file, 'UTF-8');
            
            // æ¸…ç©ºæª”æ¡ˆè¼¸å…¥
            fileInput.value = '';
        }

        // æ›´æ–°æš«å­˜æª”è³‡è¨Šé¡¯ç¤º
        function updateTempFileInfo(tempData) {
            const infoDiv = document.getElementById('tempFileInfo');
            const detailsDiv = document.getElementById('tempFileDetails');
            
            if (tempData) {
                infoDiv.style.display = 'block';
                detailsDiv.innerHTML = `
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                        <div><strong>èª²ç¨‹åç¨±:</strong> ${tempData.courseName}</div>
                        <div><strong>å„²å­˜æ™‚é–“:</strong> ${tempData.saveTimeLocal}</div>
                        <div><strong>ç‰ˆæœ¬:</strong> ${tempData.version}</div>
                        <div><strong>å§“åè³‡æ–™:</strong> ${tempData.stats.nameCount} ç­†</div>
                        <div><strong>æƒæè¨˜éŒ„:</strong> ${tempData.stats.scanCount} ç­†</div>
                        <div><strong>èª²ç¨‹è¨­å®š:</strong> ${tempData.stats.courseSet ? 'å·²è¨­å®š' : 'æœªè¨­å®š'}</div>
                    </div>
                `;
            } else {
                infoDiv.style.display = 'none';
            }
        }

        // æ›´æ–°ç‹€æ…‹æ¦‚è¦½
        function updateStatusOverview() {
            const statusCourse = document.getElementById('statusCourse');
            const statusNames = document.getElementById('statusNames');
            const statusScans = document.getElementById('statusScans');
            const statusProgress = document.getElementById('statusProgress');
            const progressBar = document.getElementById('progressBar');

            // æ›´æ–°å„é …ç‹€æ…‹
            statusCourse.textContent = courseData ? 'å·²è¨­å®š' : 'æœªè¨­å®š';
            statusNames.textContent = `${nameMapping.size} äºº`;
            statusScans.textContent = `${scannedIds.length} ç­†`;

            // è¨ˆç®—å®Œæˆåº¦ (èª²ç¨‹è¨­å®š25% + å§“ååŒ¯å…¥25% + æƒæè¨˜éŒ„50%)
            let progress = 0;
            if (courseData) progress += 25;
            if (nameMapping.size > 0) progress += 25;
            if (scannedIds.length > 0) progress += 50;

            statusProgress.textContent = `${progress}%`;
            progressBar.style.width = `${progress}%`;

            // æ ¹æ“šé€²åº¦æ”¹è®Šé€²åº¦æ¢é¡è‰²
            if (progress >= 75) {
                progressBar.style.background = 'linear-gradient(45deg, #28a745, #20c997)';
            } else if (progress >= 50) {
                progressBar.style.background = 'linear-gradient(45deg, #ffc107, #fd7e14)';
            } else {
                progressBar.style.background = 'linear-gradient(45deg, #dc3545, #e83e8c)';
            }
        }

        // æ¸…é™¤æ‰€æœ‰è³‡æ–™
        function clearAllData() {
            const hasData = courseData || nameMapping.size > 0 || scannedIds.length > 0;
            
            if (!hasData) {
                showNotification('ç›®å‰æ²’æœ‰è³‡æ–™éœ€è¦æ¸…é™¤', 'info');
                return;
            }

            const confirmMessage = `âš ï¸ ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰è³‡æ–™å—ï¼Ÿ\n\n` +
                `é€™å°‡æœƒæ¸…é™¤ï¼š\n` +
                `- èª²ç¨‹è¨­å®šè³‡æ–™\n` +
                `- æ‰€æœ‰å§“åå°æ‡‰è¡¨ (${nameMapping.size} ç­†)\n` +
                `- æ‰€æœ‰æƒæè¨˜éŒ„ (${scannedIds.length} ç­†)\n\n` +
                `å»ºè­°åœ¨æ¸…é™¤å‰å…ˆå„²å­˜æš«å­˜æª”ï¼\n\n` +
                `æ­¤æ“ä½œç„¡æ³•æ’¤éŠ·ï¼Œç¢ºå®šè¦ç¹¼çºŒå—ï¼Ÿ`;

            if (!confirm(confirmMessage)) {
                return;
            }

            // æ¸…é™¤æ‰€æœ‰è³‡æ–™
            courseData = null;
            nameMapping.clear();
            scannedIds = [];
            sequenceNumber = 1;

            // æ›´æ–°æ‰€æœ‰é¡¯ç¤º
            updateAllDisplays();
            updateStatusOverview();
            
            // éš±è—æš«å­˜æª”è³‡è¨Š
            document.getElementById('tempFileInfo').style.display = 'none';

            showNotification('æ‰€æœ‰è³‡æ–™å·²æ¸…é™¤', 'success');
            
            // åˆ‡æ›åˆ°èª²ç¨‹è¨­å®šé é¢
            switchTab('setup');
        }

        // å¼·åŒ–çš„æª”æ¡ˆä¸‹è¼‰åŠŸèƒ½
        function downloadFile(content, filename, mimeType = 'application/octet-stream') {
            try {
                // é¡¯ç¤ºä¸‹è¼‰ç‹€æ…‹
                showDownloadStatus(`æ­£åœ¨æº–å‚™ä¸‹è¼‰æª”æ¡ˆ: ${filename}`);
                
                // å»ºç«‹ Blob ç‰©ä»¶
                const blob = new Blob([content], { type: mimeType });
                const url = URL.createObjectURL(blob);
                
                // å»ºç«‹ä¸‹è¼‰é€£çµ
                const link = document.createElement('a');
                link.href = url;
                link.download = filename;
                link.style.display = 'none';
                
                // ç¢ºä¿é€£çµè¢«åŠ åˆ° DOM ä¸­
                document.body.appendChild(link);
                
                // æ¨¡æ“¬é»æ“Šä¸‹è¼‰
                link.click();
                
                // æ¸…ç†
                setTimeout(() => {
                    document.body.removeChild(link);
                    URL.revokeObjectURL(url);
                    showDownloadStatus(`âœ… æª”æ¡ˆä¸‹è¼‰å®Œæˆ: ${filename}`, 'success');
                    
                    setTimeout(() => {
                        hideDownloadStatus();
                    }, 3000);
                }, 100);
                
                return true;
            } catch (error) {
                console.error('ä¸‹è¼‰æª”æ¡ˆæ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
                showDownloadStatus(`âŒ ä¸‹è¼‰å¤±æ•—: ${error.message}`, 'error');
                
                setTimeout(() => {
                    hideDownloadStatus();
                }, 5000);
                
                return false;
            }
        }

        // é¡¯ç¤ºä¸‹è¼‰ç‹€æ…‹
        function showDownloadStatus(message, type = 'info') {
            const statusDiv = document.getElementById('downloadStatus');
            const messageDiv = document.getElementById('downloadMessage');
            
            messageDiv.textContent = message;
            statusDiv.style.display = 'block';
            
            // æ ¹æ“šé¡å‹æ”¹è®Šæ¨£å¼
            statusDiv.className = 'download-status';
            if (type === 'success') {
                statusDiv.style.borderColor = '#4caf50';
                statusDiv.style.backgroundColor = '#e8f5e8';
                statusDiv.style.color = '#2e7d32';
            } else if (type === 'error') {
                statusDiv.style.borderColor = '#f44336';
                statusDiv.style.backgroundColor = '#ffebee';
                statusDiv.style.color = '#c62828';
            } else {
                statusDiv.style.borderColor = '#2196f3';
                statusDiv.style.backgroundColor = '#e3f2fd';
                statusDiv.style.color = '#1976d2';
            }
        }

        // éš±è—ä¸‹è¼‰ç‹€æ…‹
        function hideDownloadStatus() {
            document.getElementById('downloadStatus').style.display = 'none';
        }

        function convertToROCDate(dateString) {
            if (!dateString) return '';
            
            try {
                // è™•ç† YYYY-MM-DD æ ¼å¼
                if (dateString.includes('-')) {
                    const parts = dateString.split('-');
                    const year = parseInt(parts[0]);
                    const rocYear = year - 1911;
                    
                    // å¦‚æœæ˜¯æ°‘åœ‹å‰ï¼Œå›å‚³åŸæ—¥æœŸ
                    if (rocYear <= 0) return dateString;
                    
                    return `${rocYear}-${parts[1]}-${parts[2]}`;
                }
                
                // è™•ç† YYYY/MM/DD æ ¼å¼
                if (dateString.includes('/')) {
                    const parts = dateString.split('/');
                    const year = parseInt(parts[0]);
                    const rocYear = year - 1911;
                    
                    if (rocYear <= 0) return dateString;
                    
                    return `${rocYear}/${parts[1]}/${parts[2]}`;
                }
                
                return dateString;
            } catch (error) {
                console.error('æ—¥æœŸè½‰æ›éŒ¯èª¤:', error);
                return dateString;
            }
        }

        // åŒ¯å‡ºå®Œæ•´å ±è¡¨ (Excel)
        // function exportFullReport() {
        //     if (scannedIds.length === 0) {
        //         showNotification('æ²’æœ‰æƒææ•¸æ“šå¯ä»¥åŒ¯å‡º', 'error');
        //         return;
        //     }
            
        //     if (!courseData) {
        //         showNotification('è«‹å…ˆè¨­å®šèª²ç¨‹è³‡æ–™', 'error');
        //         return;
        //     }

        //     try {
        //         const includeScanTime = document.getElementById('includeScanTime').checked;

        //         // æº–å‚™åŒ¯å‡ºæ•¸æ“š
        //         const exportData = scannedIds.map(item => {
        //             const baseData = {
        //                 'èº«ä»½è­‰å­—è™Ÿ': item.id,
        //                 'èª²ç¨‹åç¨±': courseData.courseName || '',
        //                 'é–‹èª²èµ·å§‹æ—¥æœŸ': convertToROCDate(courseData.startDate) || '',
        //                 'é–‹èª²èµ·å§‹æ™‚é–“': courseData.startTime+':00' || '',
        //                 'é–‹èª²çµæŸæ—¥æœŸ': convertToROCDate(courseData.endDate) || '',
        //                 'é–‹èª²çµæŸæ™‚é–“': courseData.endTime+':00' || '',
        //                 'å§“å': item.name,
        //                 'å­¸ä½å­¸åˆ†': courseData.credits || '',
        //                 'èª²ç¨‹é¡åˆ¥ä»£ç¢¼': courseData.courseCode || '',
        //                 'ä¸Šèª²ç¸£å¸‚': courseData.city || '',
        //                 'æœŸåˆ¥': courseData.period || '',
        //                 'è¨“ç·´ç¸½æ•¸': courseData.trainingTotal || '',
        //                 'è¨“ç·´ç¸½æ•¸å–®ä½': courseData.trainingUnit || '',
        //                 'è¨“ç·´æˆç¸¾': '',
        //                 'è­‰ä»¶å­—è™Ÿ': '',
        //                 'å‡ºå‹¤ä¸Šèª²ç‹€æ³': '',
        //                 'ç”Ÿæ—¥': '',
        //                 'å­¸ç¿’æ€§è³ª': courseData.learningType || '',
        //                 'æ•¸ä½æ™‚æ•¸': courseData.digitalHours || '',
        //                 'å¯¦é«”æ™‚æ•¸': courseData.physicalHours || '',
        //                 'èª²ç¨‹ä»£ç¢¼': '',
        //                 'å¯¦éš›ä¸Šèª²èµ·å§‹æ—¥æœŸ': convertToROCDate(courseData.startDate) || '',
        //                 'å¯¦éš›ä¸Šèª²èµ·å§‹æ™‚é–“': courseData.startTime+':00' || '',
        //                 'å¯¦éš›ä¸Šèª²çµæŸæ—¥æœŸ': convertToROCDate(courseData.endDate) || '',
        //                 'å¯¦éš›ä¸Šèª²çµæŸæ™‚é–“': courseData.endTime+':00' || ''
        //             };
                    
        //             // æ ¹æ“šé¸é …æ±ºå®šæ˜¯å¦åŒ…å«æƒææ™‚é–“
        //             if (includeScanTime) {
        //                 baseData['æƒææ™‚é–“'] = item.scanTime;
        //             }
                    
        //             return baseData;
        //         });

        //         // å‰µå»ºå·¥ä½œç°¿
        //         const ws = XLSX.utils.json_to_sheet(exportData);
        //         const wb = XLSX.utils.book_new();
        //         XLSX.utils.book_append_sheet(wb, ws, "èª²ç¨‹å‡ºå¸­å ±è¡¨");

        //         // è¨­ç½®åˆ—å¯¬
        //         const columnCount = includeScanTime ? 26 : 25;
        //         ws['!cols'] = Array(columnCount).fill({ width: 15 });

        //         // ç”Ÿæˆæª”æ¡ˆå
        //         const now = new Date();
        //         const dateStr = now.toISOString().slice(0, 10);
        //         const timeStr = now.toTimeString().slice(0, 8).replace(/:/g, '-');
        //         const courseName = courseData.courseName || 'èª²ç¨‹';
        //         const filename = `${courseName}_å‡ºå¸­å ±è¡¨_${dateStr}_${timeStr}.xlsx`;

        //         // ä½¿ç”¨å¼·åŒ–çš„ä¸‹è¼‰åŠŸèƒ½
        //         showDownloadStatus('æ­£åœ¨ç”ŸæˆExcelæª”æ¡ˆ...');
                
        //         // è½‰æ›ç‚ºäºŒé€²åˆ¶æ•¸æ“š
        //         const wbout = XLSX.write(wb, { bookType: 'xlsx', type: 'array' });
                
        //         // ä¸‹è¼‰æª”æ¡ˆ
        //         const success = downloadFile(
        //             wbout, 
        //             filename, 
        //             'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'
        //         );
                
        //         if (success) {
        //             showNotification(`Excelå ±è¡¨å·²åŒ¯å‡º: ${filename}`, 'success');
        //         } else {
        //             showNotification('ExcelåŒ¯å‡ºå¤±æ•—ï¼Œè«‹æª¢æŸ¥ç€è¦½å™¨è¨­å®š', 'error');
        //         }
                
        //     } catch (error) {
        //         console.error('åŒ¯å‡ºExcelæ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
        //         showNotification('åŒ¯å‡ºExcelæ™‚ç™¼ç”ŸéŒ¯èª¤: ' + error.message, 'error');
        //         showDownloadStatus(`âŒ ExcelåŒ¯å‡ºå¤±æ•—: ${error.message}`, 'error');
        //     }
        // }

        // åŒ¯å‡ºç‚ºæœªé–‹ç­CSV
        function exportAsCSV1() {
            if (scannedIds.length === 0) {
                showNotification('æ²’æœ‰æƒææ•¸æ“šå¯ä»¥åŒ¯å‡º', 'error');
                return;
            }
            
            if (!courseData) {
                showNotification('è«‹å…ˆè¨­å®šèª²ç¨‹è³‡æ–™', 'error');
                return;
            }

            try {
                const includeScanTime = document.getElementById('includeScanTime').checked;

                // æº–å‚™CSVæ¨™é¡Œ
                let headers = [
                    'èº«ä»½è­‰å­—è™Ÿ', 'èª²ç¨‹åç¨±', 'é–‹èª²èµ·å§‹æ—¥æœŸ', 'é–‹èª²èµ·å§‹æ™‚é–“', 
                    'é–‹èª²çµæŸæ—¥æœŸ', 'é–‹èª²çµæŸæ™‚é–“', 'å§“å', 'å­¸ä½å­¸åˆ†', 
                    'èª²ç¨‹é¡åˆ¥ä»£ç¢¼', 'ä¸Šèª²ç¸£å¸‚', 'æœŸåˆ¥', 'è¨“ç·´ç¸½æ•¸', 
                    'è¨“ç·´ç¸½æ•¸å–®ä½', 'è¨“ç·´æˆç¸¾', 'è­‰ä»¶å­—è™Ÿ', 'å‡ºå‹¤ä¸Šèª²ç‹€æ³', 
                    'ç”Ÿæ—¥', 'å­¸ç¿’æ€§è³ª', 'æ•¸ä½æ™‚æ•¸', 'å¯¦é«”æ™‚æ•¸', 
                    'èª²ç¨‹ä»£ç¢¼', 'å¯¦éš›ä¸Šèª²èµ·å§‹æ—¥æœŸ', 'å¯¦éš›ä¸Šèª²èµ·å§‹æ™‚é–“', 
                    'å¯¦éš›ä¸Šèª²çµæŸæ—¥æœŸ', 'å¯¦éš›ä¸Šèª²çµæŸæ™‚é–“'
                ];
                
                if (includeScanTime) {
                    headers.push('æƒææ™‚é–“');
                }

                // æº–å‚™CSVæ•¸æ“š
                const csvData = scannedIds.map(item => {
                    let row = [
                        item.id,
                        courseData.courseName || '',
                        convertToROCDate(courseData.startDate) || '',
                        courseData.startTime+':00' || '',
                        convertToROCDate(courseData.endDate) || '',
                        courseData.endTime+':00' || '',
                        item.name,
                        courseData.credits || '',
                        courseData.courseCode || '',
                        courseData.city || '',
                        courseData.period || '',
                        courseData.trainingTotal || '',
                        courseData.trainingUnit || '',
                        '', // è¨“ç·´æˆç¸¾
                        '', // è­‰ä»¶å­—è™Ÿ
                        '', // å‡ºå‹¤ä¸Šèª²ç‹€æ³
                        '', // ç”Ÿæ—¥
                        courseData.learningType || '',
                        courseData.digitalHours || '',
                        courseData.physicalHours || '',
                        '', // èª²ç¨‹ä»£ç¢¼
                        convertToROCDate(courseData.startDate) || '',
                        courseData.startTime+':00' || '',
                        convertToROCDate(courseData.endDate) || '',
                        courseData.endTime+':00' || ''
                    ];
                    
                    if (includeScanTime) {
                        row.push(item.scanTime);
                    }
                    
                    return row;
                });

                // çµ„åˆCSVå…§å®¹
                const csvContent = [headers, ...csvData]
                    .map(row => row.map(field => `"${field}"`).join(','))
                    .join('\n');

                // åŠ ä¸ŠBOMæ¨™è¨˜è®“Excelæ­£ç¢ºé¡¯ç¤ºä¸­æ–‡
                const csvWithBOM = '\uFEFF' + csvContent;

                // ç”Ÿæˆæª”æ¡ˆå
                const now = new Date();
                const dateStr = now.toISOString().slice(0, 10);
                const timeStr = now.toTimeString().slice(0, 8).replace(/:/g, '-');
                const courseName = courseData.courseName || 'èª²ç¨‹';
                const filename = `${courseName}_æœªé–‹èª²å‡ºå¸­å ±è¡¨_${dateStr}_${timeStr}.csv`;

                // ä¸‹è¼‰CSVæª”æ¡ˆ
                const success = downloadFile(csvWithBOM, filename, 'text/csv;charset=utf-8');
                
                if (success) {
                    showNotification(`CSVå ±è¡¨å·²åŒ¯å‡º: ${filename}`, 'success');
                } else {
                    showNotification('CSVåŒ¯å‡ºå¤±æ•—ï¼Œè«‹æª¢æŸ¥ç€è¦½å™¨è¨­å®š', 'error');
                }
                
            } catch (error) {
                console.error('åŒ¯å‡ºCSVæ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
                showNotification('åŒ¯å‡ºCSVæ™‚ç™¼ç”ŸéŒ¯èª¤: ' + error.message, 'error');
                showDownloadStatus(`âŒ CSVåŒ¯å‡ºå¤±æ•—: ${error.message}`, 'error');
            }
        }

        // åŒ¯å‡ºç‚ºå·²é–‹ç­CSV
        function exportAsCSV2() {
            if (scannedIds.length === 0) {
                showNotification('æ²’æœ‰æƒææ•¸æ“šå¯ä»¥åŒ¯å‡º', 'error');
                return;
            }
            
            if (!courseData) {
                showNotification('è«‹å…ˆè¨­å®šèª²ç¨‹è³‡æ–™', 'error');
                return;
            }

            try {
                const includeScanTime = document.getElementById('includeScanTime').checked;

                // æº–å‚™CSVæ¨™é¡Œ
                let headers = [
                    'èª²ç¨‹ä»£ç¢¼','æœŸåˆ¥', 'èº«ä»½è­‰å­—è™Ÿ', 'å§“å', 'é€šé' , 'è¨“ç·´æˆç¸¾', 'è¨“ç·´ç¸½æ•¸',
                    'è­‰ä»¶å­—è™Ÿ','å‡ºå‹¤ä¸Šèª²ç‹€æ³','ç”Ÿæ—¥','å­¸ç¿’æ€§è³ª', 'æ•¸ä½æ™‚æ•¸', 'å¯¦é«”æ™‚æ•¸',
                    'å¯¦éš›ä¸Šèª²èµ·å§‹æ—¥æœŸ', 'å¯¦éš›ä¸Šèª²èµ·å§‹æ™‚é–“', 'å¯¦éš›ä¸Šèª²çµæŸæ—¥æœŸ', 'å¯¦éš›ä¸Šèª²çµæŸæ™‚é–“'
                ];
                
                if (includeScanTime) {
                    headers.push('æƒææ™‚é–“');
                }

                // æº–å‚™CSVæ•¸æ“š
                const csvData = scannedIds.map(item => {
                    let row = [
                        courseData.courseCode || '', // èª²ç¨‹ä»£ç¢¼
                        courseData.period || '',     // æœŸåˆ¥
                        item.id,                     // èº«ä»½è­‰å­—è™Ÿ
                        item.name,                   // å§“å
                        '',                          // é€šé
                        '',                          // è¨“ç·´æˆç¸¾
                        courseData.trainingTotal || '', // è¨“ç·´ç¸½æ•¸
                        '',                          // è­‰ä»¶å­—è™Ÿ
                        '',                          // å‡ºå‹¤ä¸Šèª²ç‹€æ³
                        '',                          // ç”Ÿæ—¥
                        courseData.learningType || '', // å­¸ç¿’æ€§è³ª
                        courseData.digitalHours || '', // æ•¸ä½æ™‚æ•¸
                        courseData.physicalHours || '', // å¯¦é«”æ™‚æ•¸
                        convertToROCDate(courseData.startDate) || '', // å¯¦éš›ä¸Šèª²èµ·å§‹æ—¥æœŸ
                        courseData.startTime+':00' || '', // å¯¦éš›ä¸Šèª²èµ·å§‹æ™‚é–“
                        convertToROCDate(courseData.endDate) || '',   // å¯¦éš›ä¸Šèª²çµæŸæ—¥æœŸ
                        courseData.endTime+':00' || ''  // å¯¦éš›ä¸Šèª²çµæŸæ™‚é–“
                    ];
                      
                    
                    if (includeScanTime) {
                        row.push(item.scanTime);
                    }
                    
                    return row;
                });

                // çµ„åˆCSVå…§å®¹
                const csvContent = [headers, ...csvData]
                    .map(row => row.map(field => `"${field}"`).join(','))
                    .join('\n');

                // åŠ ä¸ŠBOMæ¨™è¨˜è®“Excelæ­£ç¢ºé¡¯ç¤ºä¸­æ–‡
                const csvWithBOM = '\uFEFF' + csvContent;

                // ç”Ÿæˆæª”æ¡ˆå
                const now = new Date();
                const dateStr = now.toISOString().slice(0, 10);
                const timeStr = now.toTimeString().slice(0, 8).replace(/:/g, '-');
                const courseName = courseData.courseName || 'èª²ç¨‹';
                const filename = `${courseName}_å·²é–‹èª²å‡ºå¸­å ±è¡¨_${dateStr}_${timeStr}.csv`;

                // ä¸‹è¼‰CSVæª”æ¡ˆ
                const success = downloadFile(csvWithBOM, filename, 'text/csv;charset=utf-8');
                
                if (success) {
                    showNotification(`CSVå ±è¡¨å·²åŒ¯å‡º: ${filename}`, 'success');
                } else {
                    showNotification('CSVåŒ¯å‡ºå¤±æ•—ï¼Œè«‹æª¢æŸ¥ç€è¦½å™¨è¨­å®š', 'error');
                }
                
            } catch (error) {
                console.error('åŒ¯å‡ºCSVæ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
                showNotification('åŒ¯å‡ºCSVæ™‚ç™¼ç”ŸéŒ¯èª¤: ' + error.message, 'error');
                showDownloadStatus(`âŒ CSVåŒ¯å‡ºå¤±æ•—: ${error.message}`, 'error');
            }
        }

        // æ›´æ–°æ‰€æœ‰é¡¯ç¤º
        function updateAllDisplays() {
            updateCourseDisplay();
            updateNameTable();
            updateScanTable();
            updateReportTable();
        }

        // æ•¸æ“šæŒä¹…åŒ– - æ”¹ç”¨è¨˜æ†¶é«”è®Šæ•¸è€ŒélocalStorage
        let dataStorage = {};

        function saveDataToStorage() {
            const data = {
                courseData: courseData,
                nameMapping: Array.from(nameMapping.entries()),
                scannedIds: scannedIds,
                sequenceNumber: sequenceNumber
            };
            try {
                dataStorage = data;
                console.log('è³‡æ–™å·²å„²å­˜åˆ°è¨˜æ†¶é«”');
            } catch (error) {
                console.error('å„²å­˜è³‡æ–™æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
                showNotification('å„²å­˜è³‡æ–™æ™‚ç™¼ç”ŸéŒ¯èª¤', 'error');
            }
        }

        function loadSavedData() {
            try {
                if (dataStorage && Object.keys(dataStorage).length > 0) {
                    const data = dataStorage;
                    courseData = data.courseData || null;
                    nameMapping = new Map(data.nameMapping || []);
                    scannedIds = data.scannedIds || [];
                    sequenceNumber = data.sequenceNumber || 1;
                    updateAllDisplays();
                    console.log('å·²è¼‰å…¥å„²å­˜çš„è³‡æ–™');
                }
            } catch (error) {
                console.error('è¼‰å…¥å„²å­˜è³‡æ–™æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
                showNotification('è¼‰å…¥å„²å­˜è³‡æ–™æ™‚ç™¼ç”ŸéŒ¯èª¤', 'error');
            }
        }

        // é€šçŸ¥åŠŸèƒ½
        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification ${type}`;
            notification.classList.add('show');

            setTimeout(() => {
                notification.classList.remove('show');
            }, 4000);
        }

        // ç¶²é é—œé–‰ç¢ºèª
        window.addEventListener('beforeunload', function(e) {
            if (scannedIds.length > 0 || nameMapping.size > 0 || courseData) {
                const confirmationMessage = 'è«‹ç¢ºèªè³‡æ–™æ˜¯å¦å·²åŒ¯å‡ºï¼Œç¢ºèªé—œé–‰ï¼Ÿ\n\nç›®å‰æœ‰æœªåŒ¯å‡ºçš„æ•¸æ“šã€‚';
                e.preventDefault();
                e.returnValue = confirmationMessage;
                return confirmationMessage;
            }
        });

        // å¿«æ·éµæ”¯æ´
        document.addEventListener('keydown', function(e) {
            // Ctrl+S åŒ¯å‡ºExcelå ±è¡¨
            if (e.ctrlKey && e.key === 's') {
                e.preventDefault();
                exportFullReport();
            }
            
            // Ctrl+Shift+S å„²å­˜æš«å­˜æª”
            if (e.ctrlKey && e.shiftKey && e.key === 'S') {
                e.preventDefault();
                saveTempFile();
            }
            
            // Ctrl+Shift+C æ¸…é™¤æƒææ•¸æ“š
            if (e.ctrlKey && e.shiftKey && e.key === 'C') {
                e.preventDefault();
                clearScanData();
            }
            
            // Ctrl+Shift+L è¼‰å…¥æš«å­˜æª”
            if (e.ctrlKey && e.shiftKey && e.key === 'L') {
                e.preventDefault();
                triggerTempFileUpload();
            }
            
            // ESC é—œé–‰å½ˆå‡ºè¦–çª—
            if (e.key === 'Escape') {
                closeEditScanModal();
                closeCourseModal();
            }
        });

        // ä¿æŒæƒæå™¨è¼¸å…¥æ¡†ç„¦é»
        setInterval(() => {
            const input = document.getElementById('idCardInput');
            const activeTab = document.querySelector('.tab-content.active');
            if (activeTab && activeTab.id === 'scan' && 
                document.activeElement !== input && 
                !document.querySelector('.modal.show')) {
                input.focus();
                input.style.imeMode = 'disabled';
            }
        }, 1000);

        // é»æ“Šå½ˆå‡ºè¦–çª—å¤–éƒ¨é—œé–‰
        document.addEventListener('click', function(e) {
            const editModal = document.getElementById('editScanModal');
            const courseModal = document.getElementById('courseModal');
            
            if (e.target === editModal) {
                closeEditScanModal();
            }
            
            if (e.target === courseModal) {
                closeCourseModal();
            }
        });

        // è‡ªå‹•å„²å­˜åŠŸèƒ½ï¼ˆæ¯30ç§’è‡ªå‹•å„²å­˜ä¸€æ¬¡ï¼‰
        setInterval(() => {
            if (scannedIds.length > 0 || nameMapping.size > 0 || courseData) {
                saveDataToStorage();
            }
        }, 30000);

        // é é¢è¼‰å…¥æ™‚é¡¯ç¤ºä½¿ç”¨èªªæ˜
        window.addEventListener('load', function() {
            setTimeout(() => {
                if (!courseData && scannedIds.length === 0 && nameMapping.size === 0) {
                    showNotification('æ­¡è¿ä½¿ç”¨ç°½åˆ°å ±è¡¨åŒ¯å‡ºç³»çµ±ï¼è«‹å…ˆè¨­å®šèª²ç¨‹è³‡æ–™', 'info');
                }
            }, 1000);
        });

        // æª¢æ¸¬ç€è¦½å™¨ä¸‹è¼‰åŠŸèƒ½æ”¯æ´
        function checkDownloadSupport() {
            const link = document.createElement('a');
            const isDownloadSupported = typeof link.download !== 'undefined';
            
            if (!isDownloadSupported) {
                showNotification('æ‚¨çš„ç€è¦½å™¨å¯èƒ½ä¸æ”¯æ´æª”æ¡ˆä¸‹è¼‰åŠŸèƒ½ï¼Œå»ºè­°ä½¿ç”¨Chromeã€Firefoxæˆ–Edge', 'error');
            }
            
            return isDownloadSupported;
        }

        // é é¢è¼‰å…¥æ™‚æª¢æŸ¥ä¸‹è¼‰æ”¯æ´
        document.addEventListener('DOMContentLoaded', function() {
            checkDownloadSupport();
        });
    </script>
</body>
</html>